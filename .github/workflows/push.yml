name: push
on:
  push:
    branches:
      - main
    paths:
      - 'go.mod'
      - '.github/workflows/push.yml'
      - '.github/licenses.tmpl'
env:
  GOPACKAGE: github.com/andyfeller/gh-dependency-report
  COMMITTER_NAME: License Updater
  COMMITTER_EMAIL: andrew.feller+license-updater@gmail.com
jobs:
  license-update:
    name: Update OSS license notices
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Generate Go license notices
        run: |
          go install github.com/google/go-licenses@latest
          go-licenses report $GOPACKAGE third-party-licenses.txt --template .github/licenses.tmpl > third-party-licenses.md || echo "Ignore warnings"
          go-licenses save $GOPACKAGE --save_path=third-party || echo "Ignore warnings"

      - name: Commit license updates
        run: |
          git config --local user.name "$COMMITTER_NAME"
          git config --local user.email "$COMMITTER_EMAIL"

          git add third-party third-party-licenses.md
          git commit -m "generate licenses - $GITHUB_SHA" || echo "No Changes in license"

          git push origin HEAD:refs/heads/main